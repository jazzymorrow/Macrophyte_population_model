---
title: "QBIO7004"
author: "jasmine fowler-morrow"
date: '2022-05-25'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The abundance of aquatic vegetation (macrophytes) in shallow lakes play a key role in reducing turbidity and providing a food source for inhabitants. However, disturbing or removing macrophytes can cause rapid and irreversible changes to conditions (scheffer, 1998). Such observations have led researchers to conclude that shallow lakes commonly have two stable states; clear and turbid (scheffer, 1993).The state of the ecosystem will change after a "tipping point" is reached.

Water mixing and light levels mean shallow lakes are rich in species. However, like many other aquatic ecosystems, the size and quality of such habitats has declined (scheffer, 1998).

The occurrence of tipping points in this ecosystem has been studied extensively (references).Previous research has found that whether or not this shift in states occurs depends on the macrophyte population size (ref). Dakos et al (2019) further argued that trait variation and evolution are important for understanding tipping point dynamics. Dakos et al (2019) found that phenotypic variation can make macrophytes more resilient to collapse. However, this model was studied analytically with trait values remaining constant through time. For this reason, I wished to add stochasticity and individual variation of trait value.

## Methods

I created an individual-based stochastic model tracking macrophyte population dynamics over time in response to turbidity. The model tracks a population of macrophyte individuals which each have a given trait value (z). The simulation begins with an initial population ($n_0$) of macrophyte individuals, each with a trait value (z). The trait value is generated with a beta distribution.

$$ P(reproducing)=r_MM\left(1-\frac{M}{K}\left(\frac{h_T^4+T^4}{h_t^4}\right)\right) $$ $$T_{t+1}=T_t+r_TT_t\left(1-\frac{T_t}{T_0\frac{h_M}{h_M+\frac{M}{K}}}\right) $$ Each time period, an individual has a fixed probability of dying. Given an individual does not die, they have a probability of reproducing (eq 1). Higher turbidity decreases their chance of reproducing as does lower trait values, which influences their response to turbidity (eq 2).

It is assumed that all reproduction is asexual, and offspring receive the same trait value as their parent with some random genetic mutation.

| Parameter                                 | Value/Range         |
|-------------------------------------------|---------------------|
| Carrying capacity (K)                     | 50                  |
| Growth rates ($r_M, r_T$)                 | 0.1                 |
| Turbidity half-saturation parameter $h_M$ | 0.2                 |
| Trait value (z)                           | $[-2,2]$            |
| Death rate ($\mu$)                        | 0.05                |
| Initial turbidity (initurb)               | ${0.1,0.3, 0.6, 1}$ |
| Background turbidity ($T_0$)              | $[2,8]^*$           |
| Genetic mutation rate ($\sigma$)          | 0.01                |
|                                           |                     |

: Table 1. Parameter values/ranges used in the model.\*values selected by Dakos et al (2019)

```{r, message = FALSE}
library(tidyverse)
library(reshape2)
#install.packages("patchwork")
library(patchwork)
```

## Code

```{r}
############## Simulation function ######################
#function to simulate macrophyte individuals and their trait values over time in response to turbidity 
#Inputs:
#inipop = dataframe of initial macrophyte population
#initurb = number describing the starting turbidity levels 
#p = list of parameters
#returns: macrophyte number, turbidity level and trait (z) mean and sd

macrophyte_growth <- function(inipop, initurb, tmax, p){
  ###set up data###
  Turb <- rep(0, tmax) #store turbidity over simulation 
  Turb[1] <- initurb #initial Turbidity level
  
  #macrophyte population
  M <- rep(0, tmax) #store population size over simulation 
  M[1] <- length(inipop$ID) #initial population size
  mtt <- as.vector(rep(NA, tmax), "list") #macrophytes through time 
  mtt[[1]] <- inipop
  
  #trait value summaries 
  Z_means <- rep(0, tmax)
  Z_means[1] <- mean(inipop$z)
  Z_sd <- rep(0, tmax)
  Z_sd[1] <- sd(inipop$z)
  
  for (i in 1:(tmax-1)){
    #create empty data frame with empty rows for reproduction
    mtt[[i+1]] <- data.frame(ID = rep(NA,p$K +20), 
                       z = NA, 
                       alive = NA) 
    mtt[[i+1]][1:nrow(mtt[[i]]),] <- mtt[[i]] #copy population over to next time step
    
    #update turbidity level
    Turb[i+1] <- Turb[i] + 
      p$rt*Turb[i]*(1-(Turb[i]/(p$T0*(p$hm/(p$hm +(M[i]/p$K))))))
    
    #determine the outcome of each individual in this time-step
    for (j in 1:length(mtt[[i+1]]$ID[!is.na(mtt[[i + 1]]$ID)])){
      #each individual has probability of death
      mtt[[i+1]]$alive[j] <- rbernoulli(1,1-p$mu) 
      
      if (mtt[[i+1]]$alive[j]){
        #if alive there is a chance of asexual reproduction
        #ht value for that individual
        ht <- exp(0.5*mtt[[i+1]]$z[j])
        reproduce <- rbernoulli(1,
                                p$rm*M[i]*(1-(M[i]/p$K)*((ht^4+Turb[i+1])/ht^4))) 
        
        if (reproduce) { #create new individual
          emptySlot <- which(is.na(mtt[[i + 1]]$ID))[1] # next empty row in dataframe
          mtt[[i+1]]$ID[emptySlot] <- last(mtt[[i+1]]$ID[!is.na(mtt[[i + 1]]$ID)]) + 1
          mtt[[i+1]]$z[emptySlot] <- mtt[[i+1]]$z[j] + rnorm(1,sd = p$sigma)
          mtt[[i+1]]$alive[emptySlot] <- TRUE

        }
      }
    }
    #remove rows with na's
    mtt[[i + 1]] <- mtt[[i + 1]][!is.na(mtt[[i + 1]]$ID),]
    #remove dead individuals
    mtt[[i + 1]] <- mtt[[i + 1]][mtt[[i + 1]]$alive,]
    #new macrophyte population size
    M[i+1] <- length(mtt[[i+1]]$ID) 
    
    # check whether population is extinct 
    if (M[i+1]==0){
      return(list(M = M, Turb = Turb, Z_means = Z_means, Z_sd = Z_sd))
      stop("Macrophyte population collapse")
    }
    
    #otherwise, update population information
    else{
      Z_means[i+1] <- mean(mtt[[i+1]]$z) #new population trait val mean
      Z_sd[i+1] <- sd(mtt[[i+1]]$z) #new population trait sd
    }

  }
  return(list(M = M, Turb = Turb, Z_means = Z_means, Z_sd = Z_sd))
}

```

```{r}
######## Running function ###########
#this function runs the macrophyte population model numerous times 
#it allows parameters and initial values to be specified 
# it requires number of simulations (n_sims)
#returns 4 matrices corresponding to macrophyte population, turbidity level, mean trait value and trait standard deviation
runMacrophyte <- function(n_sims, tmax = 100, rm = 0.1, rt = 0.1,
                          hm = 0.2, T0 = 3, zmin = 2, zmax = 2,
                          K = 50, mu = 0.05, sigma = 0.001, n0 = 10,initurb = 0.5){
  #create parameter list 
  p <- list() #parameter list 
  p$rm <- rm #macrophyte growth rate 
  p$rt <- rt #turbidity growth rate 
  p$hm <- hm #macrophyte half saturation
  p$T0 <- T0 #background turbidity
  p$K <- K #macrophyte carrying capacity
  p$mu <- mu #probability of death
  p$sigma <- sigma
  
  #create data frame for initial population 
  inipop <- data.frame(ID = 1:n0, 
                       z = 2*(-0.5+rbeta(n0, zmin, zmax)), #generate trait values
                       alive = TRUE)
  
  ##matrices to store simulation results 
  mac_pop <- matrix(nrow = n_sims,ncol = tmax)
  turb <- matrix(nrow = n_sims,ncol = tmax)
  Z_means <- matrix(nrow = n_sims,ncol = tmax)
  Z_sd <- matrix(nrow = n_sims,ncol = tmax)
  
  ##run simulations and store relevant results 
  for (i in 1:n_sims){
    results <- macrophyte_growth(inipop, initurb, tmax, p)
    mac_pop[i,] <- results$M
    turb[i,] <- results$Turb
    Z_means[i,] <- results$Z_means
    Z_sd[i,] <- results$Z_sd
  }
  return(list(mac_pop = mac_pop,turb = turb, Z_means = Z_means, Z_sd = Z_sd))
}

```

```{r}

#this function summarises the simulation results
#summary = "plot" returns a plot of the data over time 
Macrophyte_sim_summary <- function(result, summary = "plot"){
  ### MACROPHYTES ###
  df <- melt(result$mac_pop, varnames = c("Sim","Time"), value.name = "M")
  dfmean <- df %>%
    group_by(Time) %>%
    summarise(mean_M = mean(M), se = sd(M)/length(M))

  ### TURBIDITY ###
  df2 <- melt(result$turb, varnames = c("Sim","Time"), value.name = "Tb")
  df2mean <- df2 %>%
    group_by(Time) %>%
    summarise(mean_T = mean(Tb))

  ### TRAIT MEAN ###
  df3 <- melt(result$Z_means, varnames = c("Sim","Time"), value.name = "zbar")
  df3mean <- df3 %>%
    group_by(Time) %>%
    summarise(mean_z = mean(zbar))

  ### TRAIT SD ###
  df4 <- melt(result$Z_sd, varnames = c("Sim","Time"), value.name = "zsd")
  df4mean <- df4 %>%
    group_by(Time) %>%
    summarise(mean_zsd = mean(zsd))

  if (summary == "plot"){
      p1 <- ggplot() + 
        geom_line(data = df, aes(x = Time, y = M, group = Sim, 
                             colour = as.character(Sim)), 
              show.legend = FALSE, alpha = 0.3)+ 
        geom_line(data = dfmean, aes(x = Time, y = mean_M), size = 0.8) +
        theme_minimal() + labs(x = "Time step", y = "Macrophyte individuals")
      p2 <- ggplot() + 
          geom_line(data = df2, aes(x = Time, y = Tb, 
                                    group = Sim, colour = as.character(Sim)), 
                    show.legend = FALSE, alpha = 0.2)+ 
          geom_line(data = df2mean, aes(x = Time, y = mean_T), size = 0.8) +
          theme_minimal()+ labs(x = "Time step", y = "Turbidity level")
      p3 <- ggplot() + 
        geom_line(data = df3, aes(x = Time, y = zbar, group = Sim, 
                              colour = as.character(Sim)), 
              show.legend = FALSE, alpha = 0.2)+ 
        geom_line(data = df3mean, aes(x = Time, y = mean_z), size = 0.8) +
        theme_minimal()+ labs(x = "Time step", y = "Mean trait value (z)")
      p4 <- ggplot() + 
        geom_line(data = df4, aes(x = Time, y = zsd, group = Sim, 
                              colour = as.character(Sim)), 
              show.legend = FALSE, alpha = 0.2)+ 
        geom_line(data = df4mean, aes(x = Time, y = mean_zsd), size = 0.8) +
        theme_minimal()+ labs(x = "Time step", y = "Trait (z) standard deviation")
      ### use patchwork to return ###
      p <- (p1 | p2)/ (p3 | p4)
    return(p)
  }
  else if (summary == "stats"){
    M_end <- dfmean[dfmean$Time==100,2]
    Turb_end <- df2mean[df2mean$Time==100,2]
    return(data.frame(M_end = M_end, Turb_end = Turb_end))
  }
  else if(summary == "data"){
    return(list(M = df, Tb = df2, z = df3))
  }

}



```

```{r initial_turb, fig.height = 4, fig.width = 8, fig.path="./figs/"}
#### Parameter screen - results with varying initial turbidity ######
#this function summarises the simulation results from different initial turbidity values 
#returns: a plot of macrophyte numbers, turbidity and trait mean through time for each initial turbidity value
vary_initial_turbidity <- function(){
  
  #initial turbidity 
  turb <- c(0.1,0.3, 0.6, 1)
  #data frames for storing results 
  macrophytes <- data.frame(NULL)
  turbidity <- data.frame(NULL)
  trait_val <- data.frame(NULL)
  
  for (t in 1:length(turb)){
    #simulate for turbidity value t 
    result <- runMacrophyte(30, initurb = turb[t])
    
    ### MACROPHYTES ###
    df <- melt(result$mac_pop, varnames = c("Sim","Time"), value.name = "M") %>%
      group_by(Time) %>%
      summarise(mean_M = mean(M), se = sd(M)/sqrt(length(M))) %>%
      add_column(initurb = turb[t])
    macrophytes <- rbind(macrophytes, df) #include current simulation in macrophyte data
    
    ### TURBIDITY ###
    df2 <- melt(result$turb, varnames = c("Sim","Time"), value.name = "Tb") %>%
      group_by(Time) %>%
      summarise(mean_T = mean(Tb), se = sd(Tb)/length(Tb))%>%
      add_column(initurb = turb[t])
    turbidity <- rbind(turbidity,df2) #include current simulation in turbidity data
  
    ### TRAIT MEAN ###
    df3 <- melt(result$Z_means, varnames = c("Sim","Time"), value.name = "zbar")%>%
      group_by(Time) %>%
      summarise(mean_z = mean(zbar), se = sd(zbar)/length(zbar))%>%
      add_column(initurb = turb[t])
    trait_val <- rbind(trait_val,df3) #include current simulation in mean trait value data
}
### plot macrophyte numbers through time ###
  p1 <- ggplot() + 
    geom_line(data = macrophytes, aes(x = Time, y = mean_M, group = initurb, 
                                      colour = as.factor(initurb)), lwd = 1) + 
    geom_ribbon(data = macrophytes, aes(x = Time, ymin = mean_M-se, ymax = mean_M+se, 
                                        group = initurb,fill = as.character(initurb)), 
                alpha = 0.3, show.legend = FALSE)+
    theme_minimal() + labs(x = "Time step", y = "Macrophyte individuals", colour = "Initial turbidity")+ 
      theme(legend.position = "bottom")
  ### plot turbditiy levels through time ###
  p2 <- ggplot() + 
    geom_line(data = turbidity, aes(x = Time, y = mean_T, group = initurb, 
                                    colour = as.factor(initurb)), lwd = 1) +
    geom_ribbon(data = turbidity, aes(x = Time, ymin = mean_T-se, ymax = mean_T+se, 
                                        group = initurb,fill = as.character(initurb)), 
                alpha = 0.3, show.legend = FALSE)+
    theme_minimal()+ labs(x = "Time step", y = "Turbidity level", colour = "Initial turbidity")+ 
      theme(legend.position = "bottom")
  ### plot trait means (z) through time ###
  p3 <- ggplot() + 
    geom_line(data = trait_val, aes(x = Time, y = mean_z, group = initurb, 
                                    colour = as.factor(initurb)), lwd = 1) +
    geom_ribbon(data = trait_val, aes(x = Time, ymin = mean_z-se, ymax = mean_z+se, 
                                        group = initurb,fill = as.character(initurb)), 
                alpha = 0.3, show.legend = FALSE)+
    theme_minimal()+ labs(x = "Time step", y = "Mean trait value (z)", colour = "Initial turbidity")+ 
      theme(legend.position = "bottom")

  ### use patchwork to return ###
  p <- (p1 | p2 | p3) + plot_layout (guides = "collect") &
  theme(legend.position='bottom')
  return(p)

}

vary_initial_turbidity()

```

```{r initial_mac, fig.height = 4, fig.width = 8, fig.path="./figs/"}
#### Parameter screen - results with varying initial macrophyte numbers ######
#this function summarises the simulation results from different initial macrophyte population sizes  
#returns: a plot of macrophyte numbers, turbidity and trait mean through time for each initial population size
vary_initial_mac <- function(){
  
  #initial turbidity 
  size <- c(5,10, 20, 40)
  macrophytes <- data.frame(NULL)
  turbidity <- data.frame(NULL)
  trait_val <- data.frame(NULL)
  
  for (n in 1:length(size)){
    #simulate for turbidity value t 
    result <- runMacrophyte(30, n0 = size[n])
    
    ### MACROPHYTES ###
    df <- melt(result$mac_pop, varnames = c("Sim","Time"), value.name = "M") %>%
      group_by(Time) %>%
      summarise(mean_M = mean(M), se = sd(M)/sqrt(length(M))) %>%
      add_column(n0 = size[n])
    macrophytes <- rbind(macrophytes, df)
    
    ### TURBIDITY ###
    df2 <- melt(result$turb, varnames = c("Sim","Time"), value.name = "Tb") %>%
      group_by(Time) %>%
      summarise(mean_T = mean(Tb), se = sd(Tb)/length(Tb))%>%
      add_column(n0 = size[n])
    turbidity <- rbind(turbidity,df2)
  
    ### TRAIT MEAN ###
    df3 <- melt(result$Z_means, varnames = c("Sim","Time"), value.name = "zbar")%>%
      group_by(Time) %>%
      summarise(mean_z = mean(zbar), se = sd(zbar)/length(zbar))%>%
      add_column(n0 = size[n])
    trait_val <- rbind(trait_val,df3)
}
  ### plot macrophyte numbers through time ###
  p1 <- ggplot() + 
    geom_line(data = macrophytes, aes(x = Time, y = mean_M, group = n0, 
                                      colour = as.factor(n0)), lwd = 1) + 
    geom_ribbon(data = macrophytes, aes(x = Time, ymin = mean_M-se, ymax = mean_M+se, 
                                        group = n0,fill = as.factor(n0)), 
                alpha = 0.3, show.legend = FALSE)+
    theme_minimal() + labs(x = "Time step", y = "Macrophyte individuals", colour = "Initial macrophyte no.")+ 
      theme(legend.position = "bottom")
  ### plot turbidity levels through time ###
  p2 <- ggplot() + 
    geom_line(data = turbidity, aes(x = Time, y = mean_T, group = n0, 
                                    colour = as.factor(n0)), lwd = 1) +
    geom_ribbon(data = turbidity, aes(x = Time, ymin = mean_T-se, ymax = mean_T+se, 
                                        group = n0,fill = as.factor(n0)), 
                alpha = 0.3, show.legend = FALSE)+
    theme_minimal()+ labs(x = "Time step", y = "Turbidity level", colour = "Initial macrophyte no.")+ 
      theme(legend.position = "bottom")
  ### plot mean trait vals through time ###
  p3 <- ggplot() + 
    geom_line(data = trait_val, aes(x = Time, y = mean_z, group = n0, 
                                    colour = as.factor(n0)), lwd = 1) +
    geom_ribbon(data = trait_val, aes(x = Time, ymin = mean_z-se, ymax = mean_z+se, 
                                        group = n0,fill = as.factor(n0)), 
                alpha = 0.3, show.legend = FALSE)+
    theme_minimal()+ labs(x = "Time step", y = "Mean trait value (z)", colour = "Initial macrophyte no.")+ 
      theme(legend.position = "bottom")

  ### use patchwork to return ###
  p <- (p1 | p2 | p3) + plot_layout (guides = "collect") &
  theme(legend.position='bottom')
  return(p)

}

vary_initial_mac()



```

```{r background_turb, fig.path = "./figs/"}
####### simulate final population size over range of background turbidity ######
####### WITH trait variation #######
M <- rep(0,7)
final_mac <- data.frame(T0 = NULL, final_M = NULL)
for (t in 2:8){
  #run simulation for given T0 value
  result <- runMacrophyte(50, initurb = 0.5, T0 = t, n0 = 10)
  
  #average final macrophyte population size 
  M[t-1] <- Macrophyte_sim_summary(result, "stats")[[1]]
  
  #final macrophyte population size for each simulation
  Mac <- Macrophyte_sim_summary(result, summary = "data")[[1]] 
  Mac <- cbind(T0 = rep(t,10), final_M = Mac[Mac$Time==100,"M"])
  #store final size with T0 level 
  final_mac <- rbind(final_mac, Mac)
  
}

####### WITHOUT trait variation #######
M2 <- rep(0,7)
final_mac2 <- data.frame(T0 = NULL, final_M = NULL)
for (t in 2:8){
  #run simulation for given T0 value
  result <- runMacrophyte(50, initurb = 0.5, T0 = t, n0 = 10, 
                          zmin = 100, zmax = 100)
  
  #average final macrophyte population size 
  M2[t-1] <- Macrophyte_sim_summary(result, "stats")[[1]]
  
  #final macrophyte population size for each simulation
  Mac <- Macrophyte_sim_summary(result, summary = "data")[[1]] 
  Mac <- cbind(T0 = rep(t,10), final_M = Mac[Mac$Time==100,"M"])
  #store final size with T0 level 
  final_mac2 <- rbind(final_mac2, Mac)
  
}

####### final population values expected from analytic solutions ########
analytic_M <- read.csv("analytic_M.csv")

## plot of background turbidity vs population size ##
ggplot()+geom_jitter(data = final_mac, aes(x = T0, y = final_M), 
                     col = "#2c7bb6", alpha = 0.5, width = 0.1) +
  geom_line(aes(x = 2:8, y = M), col = "#2c7bb6", lwd = 1) + 
  geom_point(aes(x = 2:8, y = M), col = "#2c7bb6") +
  labs(x = "Background Turbidity (T0)", y="Final macrophyte population size")+
  geom_line(aes(x = 2:8, y = M2), col = "#d7191c", lwd = 1) +
  geom_jitter(data = final_mac2, aes(x = T0, y = final_M), 
                     col = "#d7191c", alpha = 0.5, width = 0.1)+
  geom_point(data = analytic_M, aes(x = T0, y = M), col = "#404040")+ 
  geom_line(data = analytic_M[-2,], aes(x = T0, y = M), col = "#404040", 
            lwd = 0.7, lty = 2) +
  geom_line(data = analytic_M[-3,], aes(x = T0, y = M), col = "#404040", 
            lwd = 0.7, lty = 2) +
  theme_minimal()
  


```

## Results

![The effect of background turbidity levels on final macrophyte population size.](figs/background_turb-1.pdf)

Background turbidity level negatively impacted average macrophyte population size in the final time period. However, this decrease is not as pronounced as the analytic model suggests. Furthermore, populations with higher trait variation were less affected by background turbidity and had higher average final populations.

![Macrophyte population size, turbidity level and trait value over time for various initial turbidity levels. Solid lines indicated an average value (n = 30).](figs/initial_turb-1.pdf)

Initial turbidity had no evident effect on macrophyte population dynamics. The slight differences in groups can

![Plot of Macrophyte population size, turbidity level and trait value over time for differing initial population size. ](figs/initial_mac-1.pdf)

## Conclusion

Trait variation and evolution increase the resilience of macrophyte population. Consequently, trait variation is extremely important for maintaining shallow lake ecosystems. Furthermore, initial turbidity has no effect on macrophyte population trajectories. This information is important for restoration efforts - reintroduction of macrophytes should be possible at various turbidity levels.

## Bibliography

Dakos, Matthews, B., Heny, A. P., Levine, J., Loeuille, N., Norberg, J., Nosil, P., Scheffer, M., & Meester, De, Luc. (2019). Ecosystem tipping points in an evolving world. *Nature Ecology & Evolution*, 3(3), 355--362.

Scheffer, DeAngelis, D. L., & Manly, B. J. F. (2004). *Ecology of Shallow Lakes* (Vol. 22). Springer Netherlands.

Scheffer, Hosper, S. ., Meijer, M.-L., Moss, B., & Jeppesen, E. (1993). Alternative equilibria in shallow lakes. *Trends in Ecology & Evolution*, 8(8), 275--279.
